---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: I18N?.language || 'en',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);
  // Build JSON-LD for Organization and Service in frontmatter so template can render them
  const siteUrl = SITE?.site || String(Astro.site || '');
  const org = {
    '@context': 'https://schema.org',
    '@type': 'Organization',
    name: SITE?.name || siteUrl.replace(/^https?:\/\//, ''),
    url: siteUrl,
  } as any;

  // If openGraph image available, include logo
  const ogImages = seoProps?.openGraph?.images || METADATA?.openGraph?.images;
  if (ogImages && ogImages.length > 0) {
    org.logo = Array.isArray(ogImages) ? ogImages[0]?.url || ogImages[0] : ogImages;
  }

  const ldOrg = JSON.stringify(org, undefined, 2);

  // For service pages, prepare Service JSON-LD
  let ldService: string | null = null;
  const path = String(Astro.url?.pathname || '');
  if (path.startsWith('/services')) {
    const service = {
      '@context': 'https://schema.org',
      '@type': 'Service',
      name: seoProps?.title || title || METADATA?.title?.default,
      description: seoProps?.description || description || METADATA?.description,
      provider: {
        '@type': 'Organization',
        name: SITE?.name,
        url: siteUrl,
      },
      url: seoProps?.canonical || canonical,
    } as any;

    ldService = JSON.stringify(service, undefined, 2);
  }
---

<AstroSeo {...{ ...seoProps, openGraph: await adaptOpenGraphImages(seoProps?.openGraph, Astro.site) }} />

<script type="application/ld+json" set:html={ldOrg} />
{ldService && <script type="application/ld+json" set:html={ldService} />}
